{% sw_extends '@Storefront/storefront/page/product-detail/index.html.twig' %}

{% block page_product_detail %}
    {{ parent() }}

    {% if not context.customer.groupId or shopware.config.MoorlMerchantPicker.config.customerGroupId != context.customer.groupId %}
        {% if shopware.config.MoorlMerchantFinder.config.tileLayerUrl %}
            {% set tileLayerUrl = shopware.config.MoorlMerchantFinder.config.tileLayerUrl %}
        {% else %}
            {% set tileLayerUrl = 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png' %}
        {% endif %}
        {% if shopware.config.MoorlMerchantFinder.config.tileLayerCopy %}
            {% set tileLayerCopy = shopware.config.MoorlMerchantFinder.config.tileLayerCopy %}
        {% else %}
            {% set tileLayerCopy = 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>' %}
        {% endif %}

        {% if shopware.config.MoorlMerchantFinder.config.markerCustom %}
            {# Gathering media #}
            {% set defaultMarkerMediaIds = [] %}
            {% if shopware.config.MoorlMerchantFinder.config.iconUrl %}
                {% set defaultMarkerMediaIds = defaultMarkerMediaIds|merge([shopware.config.MoorlMerchantFinder.config.iconUrl]) %}
            {% endif %}
            {% if shopware.config.MoorlMerchantFinder.config.iconRetinaUrl %}
                {% set defaultMarkerMediaIds = defaultMarkerMediaIds|merge([shopware.config.MoorlMerchantFinder.config.iconRetinaUrl]) %}
            {% endif %}
            {% if shopware.config.MoorlMerchantFinder.config.shadowUrl %}
                {% set defaultMarkerMediaIds = defaultMarkerMediaIds|merge([shopware.config.MoorlMerchantFinder.config.shadowUrl]) %}
            {% endif %}
            {% set mediaCollection = searchMedia(defaultMarkerMediaIds, context.context) %}

            {% set defaultMarker = {
                iconUrl: mediaCollection.get(shopware.config.MoorlMerchantFinder.config.iconUrl).url,
                iconRetinaUrl: mediaCollection.get(shopware.config.MoorlMerchantFinder.config.iconRetinaUrl).url,
                shadowUrl: mediaCollection.get(shopware.config.MoorlMerchantFinder.config.shadowUrl).url,
                iconSize: [
                    shopware.config.MoorlMerchantFinder.config.iconSizeX,
                    shopware.config.MoorlMerchantFinder.config.iconSizeY
                ],
                shadowSize: [
                    shopware.config.MoorlMerchantFinder.config.shadowSizeX,
                    shopware.config.MoorlMerchantFinder.config.shadowSizeY
                ],
                iconAnchor: [
                    shopware.config.MoorlMerchantFinder.config.iconAnchorX,
                    shopware.config.MoorlMerchantFinder.config.iconAnchorY
                ],
                shadowAnchor: [
                    shopware.config.MoorlMerchantFinder.config.shadowAnchorX,
                    shopware.config.MoorlMerchantFinder.config.shadowAnchorY
                ],
                popupAnchor: [
                    shopware.config.MoorlMerchantFinder.config.popupAnchorX,
                    shopware.config.MoorlMerchantFinder.config.popupAnchorY
                ]
            } %}
        {% else %}
            {% set defaultMarker = null %}
        {% endif %}

        {%  set element = {
            id: page.product.id,
            config: {
                initiator: { value: 'merchant-stock' },
                productId: { value: page.product.id }
            }
        } %}

        <div class="modal fade" id="merchantStockModal" tabindex="-1" role="dialog" aria-hidden="true">
            <div class="modal-dialog modal-xl cms-element-moorl-merchant-finder"
                 role="document"
                 data-tile-layer-url="{{ tileLayerUrl|raw }}"
                 data-tile-layer-copy='{{ tileLayerCopy|raw }}'
                 data-default-marker='{{ defaultMarker|json_encode|raw }}'
                 data-search-params="{{ shopware.config.MoorlMerchantFinder.config.searchParams }}"
                 data-position-request="{{ shopware.config.MoorlMerchantFinder.config.positionRequest }}"
                 style="--style-height: 60vh;--style-gutter: 10px;--style-results-width: 400px;">
                <div class="modal-content">
                    {% if shopware.config.MoorlMerchantStock.config.searchRules %}
                        {% for rule in shopware.config.MoorlMerchantStock.config.searchRules %}
                            <input type="hidden" name="rules[]" value="{{ rule }}">
                        {% endfor %}
                    {% endif %}

                    <div class="modal-header">
                        <h3 class="modal-title">
                            {{ page.product.translated.name }} | {{ "moorl-merchant-finder.choseMerchant"|trans }}
                        </h3>
                        <button type="button" class="modal-close close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">{% sw_icon 'x' %}</span>
                        </button>
                    </div>

                    <div class="modal-body">
                        <div class="element-content">
                            <div class="search-box">
                                {% sw_include '@MoorlMerchantFinder/plugin/moorl-merchant-finder/component/search-form.html.twig' %}
                            </div>
                            <div class="map-box">
                                <div class="map-content">
                                    {% sw_include '@MoorlMerchantFinder/plugin/moorl-merchant-finder/component/map.html.twig' %}
                                </div>
                            </div>
                            <div class="results-box">
                                <div class="results-content">
                                    {% sw_include '@MoorlMerchantFinder/plugin/moorl-merchant-finder/component/result-list.html.twig' %}
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="modal-footer text-right">
                        <button type="button" class="btn btn-light" data-dismiss="modal" aria-label="Close">
                            {{ 'moorl-merchant-finder.cancel'|trans }}
                        </button>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}
{% endblock %}